name: Generate Monthly Report

on:
  schedule:
    # ë§¤ì›” 28-31ì¼ ì˜¤í›„ 11ì‹œ (UTC)ì— ì‹¤í–‰ í›„ ë‹¤ìŒë‚ ì´ 1ì¼ì¸ì§€ ì²´í¬
    # 1ì¼ì´ë©´ ì „ì›” ë¦¬í¬íŠ¸ ìƒì„± (1ì¼ 08:00 KST = ì „ë‚  23:00 UTC)
    - cron: '0 23 28-31 * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      target_year:
        description: 'ëŒ€ìƒ ì—°ë„ (ì˜ˆ: 2025)'
        required: false
      target_month:
        description: 'ëŒ€ìƒ ì›” (ì˜ˆ: 10)'
        required: false

permissions:
  contents: write

jobs:
  monthly-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if tomorrow is 1st day of month
        id: check_date
        env:
          TZ: Asia/Seoul
        run: |
          # KST ê¸°ì¤€ ë‚´ì¼ ë‚ ì§œ (UTC+9)
          tomorrow=$(date -d tomorrow '+%d')
          
          if [ "$tomorrow" = "01" ]; then
            echo "is_first_day=true" >> $GITHUB_OUTPUT
            echo "âœ“ ë‚´ì¼ì´ 1ì¼ìž…ë‹ˆë‹¤. ì›”ê°„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
          else
            echo "is_first_day=false" >> $GITHUB_OUTPUT
            echo "âœ— ë‚´ì¼ì´ 1ì¼ì´ ì•„ë‹™ë‹ˆë‹¤. ìž‘ì—…ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi
      
      - name: Checkout repository
        if: steps.check_date.outputs.is_first_day == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
      
      - name: Calculate target month
        if: steps.check_date.outputs.is_first_day == 'true' || github.event_name == 'workflow_dispatch'
        id: calc
        env:
          TZ: Asia/Seoul
        run: |
          if [ -n "${{ github.event.inputs.target_year }}" ] && [ -n "${{ github.event.inputs.target_month }}" ]; then
            # ìˆ˜ë™ ì‹¤í–‰: ìž…ë ¥ë°›ì€ ì—°ì›” ì‚¬ìš©
            year="${{ github.event.inputs.target_year }}"
            month="${{ github.event.inputs.target_month }}"
          else
            # ìžë™ ì‹¤í–‰: ì „ì›” ê³„ì‚° (KST ê¸°ì¤€)
            # ì˜¤ëŠ˜ì´ 1ì¼ì´ë¯€ë¡œ ì „ì›”ì„ ê³„ì‚°
            current_date=$(date '+%Y-%m-01')
            prev_month=$(date -d "$current_date -1 day" '+%Y %m')
            year=$(echo $prev_month | cut -d' ' -f1)
            month=$(echo $prev_month | cut -d' ' -f2)
          fi
          
          # ì•žì˜ 0 ì œê±° (Pythonì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´)
          month_num=$((10#$month))
          
          echo "year=${year}" >> $GITHUB_OUTPUT
          echo "month=${month}" >> $GITHUB_OUTPUT
          echo "month_num=${month_num}" >> $GITHUB_OUTPUT
          
          echo "ëŒ€ìƒ ê¸°ê°„: ${year}ë…„ ${month}ì›”"
      
      - name: Generate monthly report
        if: steps.check_date.outputs.is_first_day == 'true' || github.event_name == 'workflow_dispatch'
        id: generate
        env:
          TZ: Asia/Seoul
        run: |
          year="${{ steps.calc.outputs.year }}"
          month="${{ steps.calc.outputs.month }}"
          month_num="${{ steps.calc.outputs.month_num }}"
          
          # ë¦¬í¬íŠ¸ ìƒì„±
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}"
          python3 scripts/generate_reports.py monthly ${year} ${month_num}
          
          # ìƒì„±ëœ íŒŒì¼ í™•ì¸
          report_file="output/${year}/${month}/${year}ë…„_${month}ì›”_ì›”ê°„í†µê³„.md"
          
          if [ -f "$report_file" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "report_file=${report_file}" >> $GITHUB_OUTPUT
            echo "âœ“ ì›”ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: $report_file"
            
            # ë¦¬í¬íŠ¸ì—ì„œ ì£¼ìš” ì§€í‘œ ì¶”ì¶œ
            total_products=$(grep -oP 'ì´ ë°œê²¬ ìƒí’ˆ:\s*\K\d+' "$report_file" || echo "0")
            avg_per_day=$(grep -oP 'ì¼í‰ê·  ìƒí’ˆ ìˆ˜:\s*\K[\d.]+' "$report_file" || echo "0")
            
            echo "total_products=${total_products}" >> $GITHUB_OUTPUT
            echo "avg_per_day=${avg_per_day}" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ì›”ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨ (ë°ì´í„° ë¶€ì¡± ê°€ëŠ¥ì„±)"
          fi
      
      - name: Display report summary
        if: (steps.check_date.outputs.is_first_day == 'true' || github.event_name == 'workflow_dispatch') && steps.generate.outputs.report_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          report_file="${{ steps.generate.outputs.report_file }}"
          
          echo "=== ì›”ê°„ ë¦¬í¬íŠ¸ ìš”ì•½ ==="
          if [ -f "$report_file" ]; then
            head -50 "$report_file"
          else
            echo "âš ï¸ ë¦¬í¬íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: $report_file"
          fi
      
      - name: Commit and push monthly report
        if: (steps.check_date.outputs.is_first_day == 'true' || github.event_name == 'workflow_dispatch') && steps.generate.outputs.report_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          year="${{ steps.calc.outputs.year }}"
          month="${{ steps.calc.outputs.month }}"
          total="${{ steps.generate.outputs.total_products }}"
          avg="${{ steps.generate.outputs.avg_per_day }}"
          
          # ì›ê²© ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°
          git fetch origin master
          git rebase origin/master || git merge origin/master -m "Merge remote changes"
          
          git add output/${year}/${month}/*ì›”ê°„í†µê³„.md
          git add output/${year}/${month}/*ì›”ê°„í†µê³„.csv
          
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            kst_date=$(date '+%Yë…„ %mì›” %dì¼')
            
            commit_msg="ðŸ“ˆ ì›”ê°„ ë¦¬í¬íŠ¸ ìƒì„±: ${year}ë…„ ${month}ì›”

            - ì´ ë°œê²¬ ìƒí’ˆ: ${total}ê°œ
            - ì¼í‰ê· : ${avg}ê°œ
            - ìƒì„± ì¼ì‹œ: ${kst_date}
            - ìžë™ ìƒì„±: GitHub Actions (Monthly Report)"
            
            git commit -m "$commit_msg"
            
            # Push ìž¬ì‹œë„
            for i in {1..3}; do
              if git push origin master; then
                echo "âœ“ ì›”ê°„ ë¦¬í¬íŠ¸ ì»¤ë°‹ ì™„ë£Œ"
                break
              else
                echo "âš ï¸ Push ì‹¤íŒ¨, ìž¬ì‹œë„ $i/3"
                git fetch origin master
                git rebase origin/master || git merge origin/master -m "Merge during retry"
                sleep 3
              fi
            done
          fi
      
      - name: Create summary
        if: (steps.check_date.outputs.is_first_day == 'true' || github.event_name == 'workflow_dispatch') && steps.generate.outputs.report_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          report_file="${{ steps.generate.outputs.report_file }}"
          year="${{ steps.calc.outputs.year }}"
          month="${{ steps.calc.outputs.month }}"
          total="${{ steps.generate.outputs.total_products }}"
          avg="${{ steps.generate.outputs.avg_per_day }}"
          
          echo "# ðŸ“ˆ HACIE ì›”ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë¦¬í¬íŠ¸ ê¸°ê°„:** ${year}ë…„ ${month}ì›”" >> $GITHUB_STEP_SUMMARY
          echo "**ìƒì„± ì‹œê°„:** $(date '+%Y-%m-%d %H:%M:%S') KST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š ì£¼ìš” ì§€í‘œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì´ ë°œê²¬ ìƒí’ˆ:** ${total}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ì¼í‰ê·  ìƒí’ˆ:** ${avg}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$report_file" ]; then
            echo "## ðŸ“‹ ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -60 "$report_file" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload report as artifact
        if: (steps.check_date.outputs.is_first_day == 'true' || github.event_name == 'workflow_dispatch') && steps.generate.outputs.report_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: monthly-report-${{ steps.calc.outputs.year }}-${{ steps.calc.outputs.month }}
          path: ${{ steps.generate.outputs.report_file }}
          retention-days: 730  # 2ë…„ ë³´ê´€

