name: Generate Weekly Report

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 8ì‹œ (KST = UTC 23ì‹œ, ì¼ìš”ì¼)
    - cron: '0 23 * * 0'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: szenius/set-timezone@v1
        with:
          timezoneLinux: 'Asia/Seoul'
      - run: echo "í˜„ìž¬ ì‹œê°„ì€ $(date)"
  weekly-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
      
      - name: Generate weekly report
        id: generate
        env:
          TZ: Asia/Seoul
        run: |
          # KST ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ (ì›”ìš”ì¼)
          year=$(date '+%Y')
          month=$(date '+%m')
          day=$(date '+%d')
          
          # ì£¼ì°¨ ê³„ì‚° (í•´ë‹¹ ì›”ì˜ ëª‡ ë²ˆì§¸ ì£¼ì¸ì§€)
          week_num=$(( ($(TZ=Asia/Seoul date '+%d') - 1) / 7 + 1 ))
          
          echo "year=${year}" >> $GITHUB_OUTPUT
          echo "month=${month}" >> $GITHUB_OUTPUT
          echo "week_num=${week_num}" >> $GITHUB_OUTPUT
          
          # ë¦¬í¬íŠ¸ ìƒì„±
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}"
          python3 scripts/generate_reports.py weekly ${year} ${month#0} ${week_num}
          
          # ìƒì„±ëœ íŒŒì¼ í™•ì¸
          report_file="output/${year}/${month}/${year}ë…„_${month}ì›”_${week_num}ì£¼ì°¨_í†µê³„.md"
          
          if [ -f "$report_file" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "report_file=${report_file}" >> $GITHUB_OUTPUT
            echo "âœ“ ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: $report_file"
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨ (ë°ì´í„° ë¶€ì¡± ê°€ëŠ¥ì„±)"
          fi
      
      - name: Display report summary
        if: steps.generate.outputs.report_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          report_file="${{ steps.generate.outputs.report_file }}"
          
          echo "=== ì£¼ê°„ ë¦¬í¬íŠ¸ ìš”ì•½ ==="
          if [ -f "$report_file" ]; then
            head -30 "$report_file"
          else
            echo "âš ï¸ ë¦¬í¬íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: $report_file"
          fi
      
      - name: Commit and push weekly report
        if: steps.generate.outputs.report_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          year="${{ steps.generate.outputs.year }}"
          month="${{ steps.generate.outputs.month }}"
          week_num="${{ steps.generate.outputs.week_num }}"
          
          # ì›ê²© ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°
          git fetch origin master
          git rebase origin/master || git merge origin/master -m "Merge remote changes"
          
          git add output/${year}/${month}/*ì£¼ì°¨_í†µê³„.md
          git add output/${year}/${month}/*ì£¼ì°¨_í†µê³„.csv
          
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            kst_date=$(date '+%Yë…„ %mì›” %dì¼')
            
            commit_msg="ðŸ“Š ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„±: ${year}ë…„ ${month}ì›” ${week_num}ì£¼ì°¨

            - ë¶„ì„ ê¸°ê°„: ì§€ë‚œ ì£¼ ì›”ìš”ì¼ ~ ì¼ìš”ì¼
            - ìƒì„± ì¼ì‹œ: ${kst_date}
            - ìžë™ ìƒì„±: GitHub Actions (Weekly Report)"
                        
            git commit -m "$commit_msg"
            
            # Push ìž¬ì‹œë„
            for i in {1..3}; do
              if git push origin master; then
                echo "âœ“ ì£¼ê°„ ë¦¬í¬íŠ¸ ì»¤ë°‹ ì™„ë£Œ"
                break
              else
                echo "âš ï¸ Push ì‹¤íŒ¨, ìž¬ì‹œë„ $i/3"
                git fetch origin master
                git rebase origin/master || git merge origin/master -m "Merge during retry"
                sleep 3
              fi
            done
          fi
      
      - name: Create summary
        if: steps.generate.outputs.report_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          report_file="${{ steps.generate.outputs.report_file }}"
          year="${{ steps.generate.outputs.year }}"
          month="${{ steps.generate.outputs.month }}"
          week_num="${{ steps.generate.outputs.week_num }}"
          
          echo "# ðŸ“Š HACIE ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë¦¬í¬íŠ¸ ê¸°ê°„:** ${year}ë…„ ${month}ì›” ${week_num}ì£¼ì°¨" >> $GITHUB_STEP_SUMMARY
          echo "**ìƒì„± ì‹œê°„:** $(date '+%Y-%m-%d %H:%M:%S') KST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$report_file" ]; then
            echo "## ðŸ“‹ ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -40 "$report_file" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload report as artifact
        if: steps.generate.outputs.report_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: weekly-report-${{ steps.generate.outputs.year }}-${{ steps.generate.outputs.month }}-week${{ steps.generate.outputs.week_num }}
          path: ${{ steps.generate.outputs.report_file }}
          retention-days: 365

