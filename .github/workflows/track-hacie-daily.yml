name: Track HACIE Daily Rankings

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 8ì‹œ (KST = UTC+9, ì¦‰ UTC 23ì‹œ)
    - cron: '0 23 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write

jobs:
  track-rankings:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/python:v1.55.0-jammy
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Cache pip packages
        uses: actions/cache@v4
        id: pip-cache
        with:
          path: /root/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          pip install --no-cache-dir -r requirements.txt
          python3 -c "import playwright; import requests; print('âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™•ì¸ ì™„ë£Œ')"
      
      - name: Run HACIE rankings tracker
        id: track
        env:
          TZ: Asia/Seoul
          PYTHONUNBUFFERED: "1"
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}"
          
          # ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p output
          
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ìµœëŒ€ 3íšŒ ìž¬ì‹œë„)
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ðŸ”„ ì‹œë„ $attempt/$max_attempts..."
            
            if python3 scripts/wconcept_best_export.py; then
              echo "âœ… í¬ë¡¤ë§ ì„±ê³µ!"
              exit 0
            else
              exit_code=$?
              echo "âš ï¸ ì‹œë„ $attempt ì‹¤íŒ¨ (exit code: $exit_code)"
              
              if [ $attempt -lt $max_attempts ]; then
                wait_time=$((attempt * 30))
                echo "â³ ${wait_time}ì´ˆ ëŒ€ê¸° í›„ ìž¬ì‹œë„..."
                sleep $wait_time
              fi
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "âŒ ëª¨ë“  ì‹œë„ ì‹¤íŒ¨"
          exit 1
        continue-on-error: false
      
      - name: Organize files by date
        id: organize
        env:
          TZ: Asia/Seoul
        run: |
          # KST ê¸°ì¤€ ë‚ ì§œ
          year=$(date '+%Y')
          month=$(date '+%m')
          day=$(date '+%d')
          
          # yyyy/MM/dd í´ë” ìƒì„±
          mkdir -p "output/${year}/${month}/${day}"
          
          # ìµœì‹  CSV íŒŒì¼ ì´ë™
          if ls output/wconcept_best_*.csv 1> /dev/null 2>&1; then
            latest_csv=$(ls -t output/wconcept_best_*.csv | head -1)
            mv "$latest_csv" "output/${year}/${month}/${day}/"
            
            echo "year=${year}" >> $GITHUB_OUTPUT
            echo "month=${month}" >> $GITHUB_OUTPUT
            echo "day=${day}" >> $GITHUB_OUTPUT
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "csv_file=output/${year}/${month}/${day}/$(basename $latest_csv)" >> $GITHUB_OUTPUT
            
            echo "âœ“ CSV íŒŒì¼ ì´ë™: output/${year}/${month}/${day}/$(basename $latest_csv)"
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ CSV íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi
      
      - name: Generate daily summary
        if: steps.organize.outputs.file_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          csv_file="${{ steps.organize.outputs.csv_file }}"
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          
          # CSV íŒŒì¼ ì¡´ìž¬ í™•ì¸
          if [ ! -f "$csv_file" ]; then
            echo "âŒ CSV íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $csv_file"
            exit 1
          fi
          
          # ì¼ì¼ ìš”ì•½ ìƒì„±
          summary_file="output/${year}/${month}/${day}/ì¼ì¼_ìš”ì•½.md"
          
          # HACIE ìƒí’ˆ ê°œìˆ˜ ê³„ì‚°
          hacie_count=$(grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | wc -l | xargs)
          
          # ìš”ì•½ íŒŒì¼ ìƒì„±
          cat > "$summary_file" << EOF
          # ðŸ“Š ${year}ë…„ ${month}ì›” ${day}ì¼ ì¼ì¼ ìš”ì•½
          
          **ë¶„ì„ ì‹œê°:** $(date '+%Y-%m-%d %H:%M KST')
          
          ## ì£¼ìš” ì§€í‘œ
          
          - **ë°œê²¬ëœ HACIE ìƒí’ˆ:** ${hacie_count}ê°œ
          - **ë°ì´í„° íŒŒì¼:** \`$(basename $csv_file)\`
          
          ## ðŸ“‹ ìƒìœ„ 5ê°œ ìƒí’ˆ
          
          | ìˆœìœ„ | ì¹´í…Œê³ ë¦¬ | ìƒí’ˆëª… | ê°€ê²© |
          |:----:|---------|--------|-----:|
          EOF
          
          # TOP 5 ìƒí’ˆ ì¶”ì¶œ (CSV: ë‚ ì§œ,ì‹œê°„,ë©”ì¸ì¹´í…Œê³ ë¦¬,ì„œë¸Œì¹´í…Œê³ ë¦¬,ìˆœìœ„,ìƒí’ˆëª…,ê°€ê²©)
          if grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | head -5 | while IFS=',' read -r date time depth1 depth2 rank name price rest; do
            # CSVì—ì„œ ë”°ì˜´í‘œ ì œê±°
            name_clean=$(echo "$name" | sed 's/"//g')
            price_clean=$(echo "$price" | sed 's/"//g')
            echo "| ${rank} | ${depth2} | ${name_clean:0:40} | ${price_clean} |" >> "$summary_file"
          done; then
            :
          else
            echo "| - | - | ë°ì´í„° ì—†ìŒ | - |" >> "$summary_file"
          fi
          
          cat >> "$summary_file" << EOF
          
          ---
          
          *ìžë™ ìƒì„± by GitHub Actions*
          EOF
          
          echo "âœ“ ì¼ì¼ ìš”ì•½ ìƒì„±: $summary_file"
      
      - name: Commit and push results
        if: steps.organize.outputs.file_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          # Git ì•ˆì „ ë””ë ‰í† ë¦¬ ì„¤ì • (container í™˜ê²½)
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          csv_file="${{ steps.organize.outputs.csv_file }}"
          
          # ì›ê²© ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸° (ì¶©ëŒ ë°©ì§€)
          git fetch origin master
          git rebase origin/master || {
            echo "âš ï¸ rebase ì¶©ëŒ ë°œìƒ, mergeë¡œ ì „í™˜"
            git rebase --abort
            git merge origin/master -m "Merge remote changes" || {
              echo "âŒ merge ì‹¤íŒ¨, ë³€ê²½ì‚¬í•­ í™•ì¸ í•„ìš”"
              exit 1
            }
          }
          
          # ëª¨ë“  íŒŒì¼ ì¶”ê°€
          git add output/${year}/${month}/${day}/
          
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            # HACIE ìƒí’ˆ ìˆ˜ ê³„ì‚°
            hacie_count=$(grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | wc -l | xargs)
            
            kst_date=$(date '+%Yë…„ %mì›” %dì¼ %Hì‹œ')
            
            commit_msg="ðŸ“Š HACIE ì¼ì¼ ìˆœìœ„ ì¶”ì  (${year}.${month}.${day})

            - ë°œê²¬ ìƒí’ˆ: ${hacie_count}ê°œ
            - ë¶„ì„ ì‹œê°: ${kst_date}
            - íŒŒì¼: output/${year}/${month}/${day}/

            ìžë™ ìƒì„± by GitHub Actions"
            
            git commit -m "$commit_msg"
            
            # Push ìž¬ì‹œë„ ë¡œì§
            max_push_attempts=3
            push_attempt=1
            
            while [ $push_attempt -le $max_push_attempts ]; do
              echo "ðŸ”„ Push ì‹œë„ $push_attempt/$max_push_attempts..."
              
              if git push origin master; then
                echo "âœ“ ì»¤ë°‹ ì™„ë£Œ: ${hacie_count}ê°œ ìƒí’ˆ"
                exit 0
              else
                echo "âš ï¸ Push ì‹¤íŒ¨, ì›ê²© ë³€ê²½ì‚¬í•­ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°..."
                git fetch origin master
                git rebase origin/master || {
                  git rebase --abort
                  git merge origin/master -m "Merge remote changes during push retry"
                }
                
                push_attempt=$((push_attempt + 1))
                
                if [ $push_attempt -le $max_push_attempts ]; then
                  sleep 5
                fi
              fi
            done
            
            echo "âŒ Push ìµœì¢… ì‹¤íŒ¨"
            exit 1
          fi
      
      - name: Create summary
        if: steps.organize.outputs.file_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          csv_file="${{ steps.organize.outputs.csv_file }}"
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          
          hacie_count=$(grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | wc -l | xargs)
          
          echo "# ðŸ† HACIE ì¼ì¼ ìˆœìœ„ ì¶”ì  ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë‚ ì§œ:** ${year}ë…„ ${month}ì›” ${day}ì¼" >> $GITHUB_STEP_SUMMARY
          echo "**ë¶„ì„ ì‹œê°:** $(date '+%Y-%m-%d %H:%M:%S') KST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë°œê²¬ëœ HACIE ìƒí’ˆ:** ${hacie_count}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $hacie_count -gt 0 ]; then
            echo "## ðŸ“‹ ìƒìœ„ 10ê°œ ìƒí’ˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```csv' >> $GITHUB_STEP_SUMMARY
            head -1 "$csv_file" >> $GITHUB_STEP_SUMMARY
            grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload results as artifact
        if: steps.organize.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-rankings-${{ steps.organize.outputs.year }}-${{ steps.organize.outputs.month }}-${{ steps.organize.outputs.day }}
          path: output/${{ steps.organize.outputs.year }}/${{ steps.organize.outputs.month }}/${{ steps.organize.outputs.day }}/
          retention-days: 90
