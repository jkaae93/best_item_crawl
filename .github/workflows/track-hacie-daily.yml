name: Track HACIE Daily Rankings
on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 8ì‹œ (KST = UTC+9, ì¦‰ UTC 23ì‹œ)
    - cron: '0 23 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
permissions:
  contents: write
jobs:
  track-rankings:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/python:v1.55.0-jammy
    
    env:
      TZ: Asia/Seoul  # ì „ì—­ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Cache pip packages
        uses: actions/cache@v4
        id: pip-cache
        with:
          path: /root/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          pip install --no-cache-dir -r requirements.txt
          python3 -c "import playwright; import requests; print('âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™•ì¸ ì™„ë£Œ')"
      
      - name: Set KST timezone
        run: |
          # ì‹œìŠ¤í…œ timezone ì„¤ì •
          ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime
          echo "Asia/Seoul" > /etc/timezone
          
          # í™•ì¸
          echo "í˜„ì¬ ì‹œìŠ¤í…œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "Pythonì—ì„œ ì¸ì‹í•˜ëŠ” ì‹œê°„:"
          python3 -c "from datetime import datetime; print(datetime.now().strftime('%Y-%m-%d %H:%M:%S'))"
      
      - name: Run HACIE rankings tracker
        id: track
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}"
          
          # ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p output
          mkdir -p data
          
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì „ ë‚ ì§œ í™•ì¸
          echo "ğŸ• ì‹¤í–‰ ì‹œê° (KST): $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ìµœëŒ€ 3íšŒ ì¬ì‹œë„)
          # --skip-category-update ì‚¬ìš©í•˜ì—¬ ë¹ ë¥´ê²Œ ì‹¤í–‰
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ ì‹œë„ $attempt/$max_attempts..."
            
            if python3 scripts/wconcept_best_export.py --skip-category-update; then
              echo "âœ… í¬ë¡¤ë§ ì„±ê³µ!"
              exit 0
            else
              exit_code=$?
              echo "âš ï¸ ì‹œë„ $attempt ì‹¤íŒ¨ (exit code: $exit_code)"
              
              if [ $attempt -lt $max_attempts ]; then
                wait_time=$((attempt * 30))
                echo "â³ ${wait_time}ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
                sleep $wait_time
              fi
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "âŒ ëª¨ë“  ì‹œë„ ì‹¤íŒ¨"
          exit 1
        continue-on-error: false
      
      - name: Organize files by date
        id: organize
        run: |
          # KST ê¸°ì¤€ ë‚ ì§œ ë° ì‹œê°„
          year=$(date '+%Y')
          month=$(date '+%m')
          day=$(date '+%d')
          timestamp=$(date '+%H%M%S')
          
          echo "ğŸ“… ì •ë¦¬ ë‚ ì§œ (KST): ${year}ë…„ ${month}ì›” ${day}ì¼ ${timestamp:0:2}:${timestamp:2:2}:${timestamp:4:2}"
          
          # yyyy/MM/dd í´ë” ìƒì„±
          mkdir -p "output/${year}/${month}/${day}"
          
          # ìµœì‹  CSV íŒŒì¼ ì°¾ê¸°
          if ls output/wconcept_best_*.csv 1> /dev/null 2>&1; then
            latest_csv=$(ls -t output/wconcept_best_*.csv | head -1)
            echo "ğŸ“‚ ë°œê²¬ëœ CSV íŒŒì¼: $latest_csv"
            
            # ê¸°ì¡´ íŒŒì¼ëª…ì—ì„œ í™•ì¥ì ë¶„ë¦¬
            base_name=$(basename "$latest_csv" .csv)
            
            # ìƒˆ íŒŒì¼ëª…: ê¸°ì¡´ì´ë¦„_HHMMSS.csv
            new_csv_name="${base_name}_${timestamp}.csv"
            new_csv_path="output/${year}/${month}/${day}/${new_csv_name}"
            
            # íŒŒì¼ ì´ë™ ë° ì´ë¦„ ë³€ê²½
            mv "$latest_csv" "$new_csv_path"
            
            echo "year=${year}" >> $GITHUB_OUTPUT
            echo "month=${month}" >> $GITHUB_OUTPUT
            echo "day=${day}" >> $GITHUB_OUTPUT
            echo "timestamp=${timestamp}" >> $GITHUB_OUTPUT
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "csv_file=${new_csv_path}" >> $GITHUB_OUTPUT
            echo "csv_name=${new_csv_name}" >> $GITHUB_OUTPUT
            
            echo "âœ“ CSV íŒŒì¼ ì´ë™: ${new_csv_path}"
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ CSV íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi
      
      - name: Generate daily summary
        if: steps.organize.outputs.file_exists == 'true'
        run: |
          csv_file="${{ steps.organize.outputs.csv_file }}"
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          timestamp="${{ steps.organize.outputs.timestamp }}"
          csv_name="${{ steps.organize.outputs.csv_name }}"
          
          # CSV íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [ ! -f "$csv_file" ]; then
            echo "âŒ CSV íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $csv_file"
            exit 1
          fi
          
          echo "ğŸ“„ ë¶„ì„í•  CSV íŒŒì¼: $csv_file"
          echo "ğŸ“Š CSV íŒŒì¼ í¬ê¸°: $(wc -l < "$csv_file") ì¤„"
          
          # CSV ì²« 5ì¤„ ìƒ˜í”Œ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
          echo "ğŸ“‹ CSV ìƒ˜í”Œ (ì²« 5ì¤„):"
          head -5 "$csv_file"
          echo ""
          
          # HACIE ìƒí’ˆ ë¼ì¸ ìƒ˜í”Œ ì¶œë ¥
          echo "ğŸ” HACIE ìƒí’ˆ ìƒ˜í”Œ (ì²« 3ê°œ):"
          grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | head -3 || echo "HACIE ìƒí’ˆ ì—†ìŒ"
          echo ""
          
          # HACIE ìƒí’ˆ ê°œìˆ˜ ê³„ì‚°
          hacie_count=$(grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | wc -l | xargs)
          echo "ğŸ“Š ë°œê²¬ëœ HACIE ìƒí’ˆ: ${hacie_count}ê°œ"
          
          # ë§ˆí¬ë‹¤ìš´ íŒŒì¼ëª…: ì¼ì¼_ìš”ì•½_HHMMSS.md
          summary_file="output/${year}/${month}/${day}/ì¼ì¼_ìš”ì•½_${timestamp}.md"
          
          # ìš”ì•½ íŒŒì¼ ìƒì„±
          cat > "$summary_file" << 'EOF_HEADER'
# ğŸ“Š ì¼ì¼ ìš”ì•½

**ë¶„ì„ ì‹œê°:** KST_PLACEHOLDER  
**ë°ì´í„° íŒŒì¼:** `CSV_NAME_PLACEHOLDER`  
**ë°œê²¬ëœ HACIE ìƒí’ˆ:** HACIE_COUNT_PLACEHOLDERê°œ

---

## ğŸ“‹ ìƒìœ„ 10ê°œ ìƒí’ˆ

EOF_HEADER
          
          # í”Œë ˆì´ìŠ¤í™€ë” ì¹˜í™˜
          sed -i "s/KST_PLACEHOLDER/$(date '+%Y-%m-%d %H:%M:%S') KST/" "$summary_file"
          sed -i "s/CSV_NAME_PLACEHOLDER/${csv_name}/" "$summary_file"
          sed -i "s/HACIE_COUNT_PLACEHOLDER/${hacie_count}/" "$summary_file"
          
          if [ $hacie_count -gt 0 ]; then
            # í…Œì´ë¸” í—¤ë” ì¶”ê°€
            cat >> "$summary_file" << 'EOF_TABLE'
| ìˆœìœ„ | ì¹´í…Œê³ ë¦¬ | ìƒí’ˆëª… | ê°€ê²© |
|:----:|---------|--------|-----:|
EOF_TABLE
            
            # Pythonìœ¼ë¡œ CSV íŒŒì‹± (ë” ì •í™•í•¨)
            python3 << 'EOF_PYTHON' >> "$summary_file"
import csv
import sys

csv_file = sys.argv[1] if len(sys.argv) > 1 else ""

try:
    with open(csv_file, 'r', encoding='utf-8') as f:
        reader = csv.reader(f)
        header = next(reader)  # í—¤ë” ìŠ¤í‚µ
        
        count = 0
        for row in reader:
            if len(row) < 7:
                continue
            
            # ìƒí’ˆëª…ì—ì„œ HACIE ê²€ìƒ‰ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
            product_name = row[5] if len(row) > 5 else ""
            if 'hacie' not in product_name.lower() and 'í•˜ì‹œì—' not in product_name:
                continue
            
            # ë°ì´í„° ì¶”ì¶œ
            rank = row[4] if len(row) > 4 else "-"
            category = row[3] if len(row) > 3 else "-"
            price = row[6] if len(row) > 6 else "-"
            
            # ìƒí’ˆëª… ê¸¸ì´ ì œí•œ
            if len(product_name) > 50:
                product_name = product_name[:50] + "..."
            
            print(f"| {rank} | {category} | {product_name} | {price} |")
            
            count += 1
            if count >= 10:
                break

except Exception as e:
    print(f"| - | - | CSV íŒŒì‹± ì˜¤ë¥˜: {str(e)} | - |", file=sys.stderr)
EOF_PYTHON
python3 -c "
import csv
csv_file = '${csv_file}'
try:
    with open(csv_file, 'r', encoding='utf-8') as f:
        reader = csv.reader(f)
        header = next(reader)
        count = 0
        for row in reader:
            if len(row) < 7:
                continue
            product_name = row[5] if len(row) > 5 else ''
            if 'hacie' not in product_name.lower() and 'í•˜ì‹œì—' not in product_name:
                continue
            rank = row[4] if len(row) > 4 else '-'
            category = row[3] if len(row) > 3 else '-'
            price = row[6] if len(row) > 6 else '-'
            if len(product_name) > 50:
                product_name = product_name[:50] + '...'
            print(f'| {rank} | {category} | {product_name} | {price} |')
            count += 1
            if count >= 10:
                break
except Exception as e:
    print(f'CSV íŒŒì‹± ì˜¤ë¥˜: {e}')
" >> "$summary_file"
            
            # ì „ì²´ ìƒí’ˆ ëª©ë¡ ì„¹ì…˜
            cat >> "$summary_file" << 'EOF_DETAILS'

---

## ğŸ“¦ ì „ì²´ HACIE ìƒí’ˆ ëª©ë¡

<details>
<summary>í¼ì³ì„œ ë³´ê¸° (ì „ì²´ ITEM_COUNT_PLACEHOLDERê°œ)</summary>

| ìˆœìœ„ | ì¹´í…Œê³ ë¦¬ | ìƒí’ˆëª… | ê°€ê²© |
|:----:|---------|--------|-----:|
EOF_DETAILS
            
            sed -i "s/ITEM_COUNT_PLACEHOLDER/${hacie_count}/" "$summary_file"
            
            # ì „ì²´ ëª©ë¡ ì¶”ê°€
            python3 -c "
import csv
csv_file = '${csv_file}'
try:
    with open(csv_file, 'r', encoding='utf-8') as f:
        reader = csv.reader(f)
        header = next(reader)
        for row in reader:
            if len(row) < 7:
                continue
            product_name = row[5] if len(row) > 5 else ''
            if 'hacie' not in product_name.lower() and 'í•˜ì‹œì—' not in product_name:
                continue
            rank = row[4] if len(row) > 4 else '-'
            category = row[3] if len(row) > 3 else '-'
            price = row[6] if len(row) > 6 else '-'
            if len(product_name) > 60:
                product_name = product_name[:60] + '...'
            print(f'| {rank} | {category} | {product_name} | {price} |')
except Exception as e:
    print(f'CSV íŒŒì‹± ì˜¤ë¥˜: {e}')
" >> "$summary_file"
            
            cat >> "$summary_file" << 'EOF_CLOSE'

</details>
EOF_CLOSE
          else
            cat >> "$summary_file" << 'EOF_NODATA'

**HACIE ìƒí’ˆì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.**

EOF_NODATA
          fi
          
          # í‘¸í„° ì¶”ê°€
          cat >> "$summary_file" << 'EOF_FOOTER'

---

**ğŸ“ˆ ë¶„ì„ ì •ë³´**
- ì´ ë°ì´í„° í–‰ ìˆ˜: LINE_COUNT_PLACEHOLDER ì¤„
- CSV íŒŒì¼ëª…: `CSV_NAME_FOOTER_PLACEHOLDER`
- ìƒì„± ì‹œê°: TIME_PLACEHOLDER KST

*ìë™ ìƒì„± by GitHub Actions*
EOF_FOOTER
          
          # í”Œë ˆì´ìŠ¤í™€ë” ì¹˜í™˜
          line_count=$(wc -l < "$csv_file")
          sed -i "s/LINE_COUNT_PLACEHOLDER/${line_count}/" "$summary_file"
          sed -i "s/CSV_NAME_FOOTER_PLACEHOLDER/${csv_name}/" "$summary_file"
          sed -i "s|TIME_PLACEHOLDER|$(date '+%Y-%m-%d %H:%M:%S')|" "$summary_file"
          
          echo "âœ… ì¼ì¼ ìš”ì•½ ìƒì„± ì™„ë£Œ: $summary_file"
          
          # ìƒì„±ëœ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
          echo ""
          echo "ğŸ“„ ë§ˆí¬ë‹¤ìš´ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:"
          head -30 "$summary_file"
          echo ""
          echo "... (ì¤‘ëµ) ..."
      
      - name: Commit and push results
        if: steps.organize.outputs.file_exists == 'true'
        run: |
          # Git ì•ˆì „ ë””ë ‰í† ë¦¬ ì„¤ì • (container í™˜ê²½)
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          timestamp="${{ steps.organize.outputs.timestamp }}"
          csv_file="${{ steps.organize.outputs.csv_file }}"
          
          # ì›ê²© ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸° (ì¶©ëŒ ë°©ì§€)
          git fetch origin master
          git rebase origin/master || {
            echo "âš ï¸ rebase ì¶©ëŒ ë°œìƒ, mergeë¡œ ì „í™˜"
            git rebase --abort
            git merge origin/master -m "Merge remote changes" || {
              echo "âŒ merge ì‹¤íŒ¨, ë³€ê²½ì‚¬í•­ í™•ì¸ í•„ìš”"
              exit 1
            }
          }
          
          # ëª¨ë“  íŒŒì¼ ì¶”ê°€
          git add output/${year}/${month}/${day}/
          
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            # HACIE ìƒí’ˆ ìˆ˜ ê³„ì‚°
            hacie_count=$(grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | wc -l | xargs)
            
            kst_time=$(date '+%Yë…„ %mì›” %dì¼ %H:%M:%S')
            
            commit_msg="ğŸ“Š HACIE ì¼ì¼ ìˆœìœ„ ì¶”ì  (${year}.${month}.${day} ${timestamp:0:2}:${timestamp:2:2}:${timestamp:4:2})

- ë°œê²¬ ìƒí’ˆ: ${hacie_count}ê°œ
- ë¶„ì„ ì‹œê°: ${kst_time}
- íŒŒì¼: output/${year}/${month}/${day}/

ìë™ ìƒì„± by GitHub Actions"
            
            git commit -m "$commit_msg"
            
            # Push ì¬ì‹œë„ ë¡œì§
            max_push_attempts=3
            push_attempt=1
            
            while [ $push_attempt -le $max_push_attempts ]; do
              echo "ğŸ”„ Push ì‹œë„ $push_attempt/$max_push_attempts..."
              
              if git push origin master; then
                echo "âœ… ì»¤ë°‹ ì™„ë£Œ: ${hacie_count}ê°œ ìƒí’ˆ"
                exit 0
              else
                echo "âš ï¸ Push ì‹¤íŒ¨, ì›ê²© ë³€ê²½ì‚¬í•­ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°..."
                git fetch origin master
                git rebase origin/master || {
                  git rebase --abort
                  git merge origin/master -m "Merge remote changes during push retry"
                }
                
                push_attempt=$((push_attempt + 1))
                
                if [ $push_attempt -le $max_push_attempts ]; then
                  sleep 5
                fi
              fi
            done
            
            echo "âŒ Push ìµœì¢… ì‹¤íŒ¨"
            exit 1
          fi
      
      - name: Create summary
        if: steps.organize.outputs.file_exists == 'true'
        run: |
          csv_file="${{ steps.organize.outputs.csv_file }}"
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          timestamp="${{ steps.organize.outputs.timestamp }}"
          
          hacie_count=$(grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | wc -l | xargs)
          
          echo "# ğŸ† HACIE ì¼ì¼ ìˆœìœ„ ì¶”ì  ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë‚ ì§œ:** ${year}ë…„ ${month}ì›” ${day}ì¼" >> $GITHUB_STEP_SUMMARY
          echo "**ì‹œê°:** ${timestamp:0:2}:${timestamp:2:2}:${timestamp:4:2} KST" >> $GITHUB_STEP_SUMMARY
          echo "**ë°œê²¬ëœ HACIE ìƒí’ˆ:** ${hacie_count}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $hacie_count -gt 0 ]; then
            echo "## ğŸ“‹ ìƒìœ„ 10ê°œ ìƒí’ˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '| ìˆœìœ„ | ì¹´í…Œê³ ë¦¬ | ìƒí’ˆëª… | ê°€ê²© |' >> $GITHUB_STEP_SUMMARY
            echo '|:----:|---------|--------|-----:|' >> $GITHUB_STEP_SUMMARY
            
            grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | head -10 | while IFS=',' read -r date time depth1 depth2 rank name price rest; do
              name_clean=$(echo "$name" | sed 's/"//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              price_clean=$(echo "$price" | sed 's/"//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              rank_clean=$(echo "$rank" | sed 's/"//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              depth2_clean=$(echo "$depth2" | sed 's/"//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              
              if [ ${#name_clean} -gt 40 ]; then
                name_clean="${name_clean:0:40}..."
              fi
              
              echo "| ${rank_clean} | ${depth2_clean} | ${name_clean} | ${price_clean} |" >> $GITHUB_STEP_SUMMARY
            done
          fi
      
      - name: Upload results as artifact
        if: steps.organize.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-rankings-${{ steps.organize.outputs.year }}${{ steps.organize.outputs.month }}${{ steps.organize.outputs.day }}-${{ steps.organize.outputs.timestamp }}
          path: output/${{ steps.organize.outputs.year }}/${{ steps.organize.outputs.month }}/${{ steps.organize.outputs.day }}/
          retention-days: 90
      
      - name: Send Slack notification
        if: steps.organize.outputs.file_exists == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          csv_file="${{ steps.organize.outputs.csv_file }}"
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          timestamp="${{ steps.organize.outputs.timestamp }}"
          csv_name="${{ steps.organize.outputs.csv_name }}"
          
          # HACIE ìƒí’ˆ ìˆ˜ ê³„ì‚°
          hacie_count=$(grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | wc -l | xargs)
          
          # í˜„ì¬ ì‹œê°
          kst_time=$(date '+%Yë…„ %mì›” %dì¼ %H:%M:%S')
          
          # ìƒìœ„ 5ê°œ ìƒí’ˆ ì¶”ì¶œ (Slack ë©”ì‹œì§€ìš©)
          top5_text=""
          if [ $hacie_count -gt 0 ]; then
            top5_text=$(python3 -c "
import csv
csv_file = '${csv_file}'
items = []
try:
    with open(csv_file, 'r', encoding='utf-8') as f:
        reader = csv.reader(f)
        header = next(reader)
        count = 0
        for row in reader:
            if len(row) < 7:
                continue
            product_name = row[5] if len(row) > 5 else ''
            if 'hacie' not in product_name.lower() and 'í•˜ì‹œì—' not in product_name:
                continue
            rank = row[4] if len(row) > 4 else '-'
            category = row[3] if len(row) > 3 else '-'
            if len(product_name) > 40:
                product_name = product_name[:40] + '...'
            items.append(f'{rank}ìœ„. {product_name} ({category})')
            count += 1
            if count >= 5:
                break
    print('\n'.join(items))
except Exception as e:
    print('ë°ì´í„° ì¶”ì¶œ ì˜¤ë¥˜')
")
          fi
          
          # Repository URL
          repo_url="https://github.com/${GITHUB_REPOSITORY}"
          file_path="output/${year}/${month}/${day}"
          file_url="${repo_url}/tree/master/${file_path}"
          
          # Slack ë©”ì‹œì§€ ìƒì„±
          if [ $hacie_count -gt 0 ]; then
            status_emoji="âœ…"
            status_color="good"
            summary_text="HACIE ìƒí’ˆ *${hacie_count}ê°œ* ë°œê²¬!"
          else
            status_emoji="âš ï¸"
            status_color="warning"
            summary_text="HACIE ìƒí’ˆì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi
          
          # JSON payload ìƒì„±
          payload=$(cat <<EOF
{
  "text": "${status_emoji} HACIE ì¼ì¼ ìˆœìœ„ ì¶”ì  ì™„ë£Œ",
  "attachments": [
    {
      "color": "${status_color}",
      "title": "ğŸ“Š ${year}ë…„ ${month}ì›” ${day}ì¼ ìˆœìœ„ ë¶„ì„",
      "title_link": "${file_url}",
      "fields": [
        {
          "title": "ë°œê²¬ ìƒí’ˆ",
          "value": "${hacie_count}ê°œ",
          "short": true
        },
        {
          "title": "ë¶„ì„ ì‹œê°",
          "value": "${kst_time} KST",
          "short": true
        },
        {
          "title": "ë°ì´í„° íŒŒì¼",
          "value": "\`${csv_name}\`",
          "short": false
        }
      ],
      "footer": "GitHub Actions",
      "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
      "ts": $(date +%s)
    }
  ]
}
EOF
)
          
          # ìƒìœ„ 5ê°œ ìƒí’ˆì´ ìˆìœ¼ë©´ ì¶”ê°€
          if [ ! -z "$top5_text" ]; then
            payload=$(cat <<EOF
{
  "text": "${status_emoji} HACIE ì¼ì¼ ìˆœìœ„ ì¶”ì  ì™„ë£Œ",
  "attachments": [
    {
      "color": "${status_color}",
      "title": "ğŸ“Š ${year}ë…„ ${month}ì›” ${day}ì¼ ìˆœìœ„ ë¶„ì„",
      "title_link": "${file_url}",
      "fields": [
        {
          "title": "ë°œê²¬ ìƒí’ˆ",
          "value": "${hacie_count}ê°œ",
          "short": true
        },
        {
          "title": "ë¶„ì„ ì‹œê°",
          "value": "${kst_time} KST",
          "short": true
        },
        {
          "title": "ë°ì´í„° íŒŒì¼",
          "value": "\`${csv_name}\`",
          "short": false
        },
        {
          "title": "ğŸ† ìƒìœ„ 5ê°œ ìƒí’ˆ",
          "value": "${top5_text}",
          "short": false
        }
      ],
      "footer": "GitHub Actions",
      "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
      "ts": $(date +%s)
    }
  ]
}
EOF
)
          fi
          
          # Slack ì›¹í›… ì „ì†¡
          echo "ğŸ“¤ Slack ì•Œë¦¼ ì „ì†¡ ì¤‘..."
          response=$(curl -X POST \
            -H 'Content-type: application/json' \
            --data "$payload" \
            -w "\n%{http_code}" \
            -s \
            "$SLACK_WEBHOOK_URL")
          
          http_code=$(echo "$response" | tail -n 1)
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Slack ì•Œë¦¼ ì „ì†¡ ì„±ê³µ!"
          else
            echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (HTTP ${http_code})"
            echo "Response: $(echo "$response" | head -n -1)"
          fi
