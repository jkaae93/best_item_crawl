name: Track HACIE Daily Rankings

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 8ì‹œ (KST = UTC+9, ì¦‰ UTC 23ì‹œ)
    - cron: '0 23 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write

jobs:
  track-rankings:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium
      
      - name: Run HACIE rankings tracker
        id: track
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}"
          python3 scripts/wconcept_best_export.py
        continue-on-error: false
      
      - name: Organize files by date
        id: organize
        run: |
          # KST ê¸°ì¤€ ë‚ ì§œ
          year=$(TZ=Asia/Seoul date '+%Y')
          month=$(TZ=Asia/Seoul date '+%m')
          day=$(TZ=Asia/Seoul date '+%d')
          
          # yyyy/MM/dd í´ë” ìƒì„±
          mkdir -p "output/${year}/${month}/${day}"
          
          # ìµœì‹  CSV íŒŒì¼ ì´ë™
          if ls output/wconcept_best_*.csv 1> /dev/null 2>&1; then
            latest_csv=$(ls -t output/wconcept_best_*.csv | head -1)
            mv "$latest_csv" "output/${year}/${month}/${day}/"
            
            echo "year=${year}" >> $GITHUB_OUTPUT
            echo "month=${month}" >> $GITHUB_OUTPUT
            echo "day=${day}" >> $GITHUB_OUTPUT
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "csv_file=output/${year}/${month}/${day}/$(basename $latest_csv)" >> $GITHUB_OUTPUT
            
            echo "âœ“ CSV íŒŒì¼ ì´ë™: output/${year}/${month}/${day}/$(basename $latest_csv)"
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ CSV íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi
      
      - name: Generate daily summary
        if: steps.organize.outputs.file_exists == 'true'
        run: |
          csv_file="${{ steps.organize.outputs.csv_file }}"
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          
          # ì¼ì¼ ìš”ì•½ ìƒì„±
          summary_file="output/${year}/${month}/${day}/ì¼ì¼_ìš”ì•½.md"
          
          # HACIE ìƒí’ˆ ê°œìˆ˜ ê³„ì‚°
          hacie_count=$(grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | wc -l | xargs)
          
          # ìš”ì•½ íŒŒì¼ ìƒì„±
          cat > "$summary_file" << EOF
          # ðŸ“Š ${year}ë…„ ${month}ì›” ${day}ì¼ ì¼ì¼ ìš”ì•½
          
          **ë¶„ì„ ì‹œê°:** $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M KST')
          
          ## ì£¼ìš” ì§€í‘œ
          
          - **ë°œê²¬ëœ HACIE ìƒí’ˆ:** ${hacie_count}ê°œ
          - **ë°ì´í„° íŒŒì¼:** \`$(basename $csv_file)\`
          
          ## ðŸ“‹ ìƒìœ„ 5ê°œ ìƒí’ˆ
          
          | ìˆœìœ„ | ì¹´í…Œê³ ë¦¬ | ìƒí’ˆëª… | ê°€ê²© |
          |:----:|---------|--------|-----:|
          EOF
          
          # TOP 5 ìƒí’ˆ ì¶”ì¶œ
          grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | head -5 | while IFS=',' read -r d1c d1n d2c d2n rank brand name price rest; do
            echo "| ${rank} | ${d2n} | ${name:0:40} | ${price} |" >> "$summary_file"
          done || echo "| - | - | ë°ì´í„° ì—†ìŒ | - |" >> "$summary_file"
          
          cat >> "$summary_file" << EOF
          
          ---
          
          *ìžë™ ìƒì„± by GitHub Actions*
          EOF
          
          echo "âœ“ ì¼ì¼ ìš”ì•½ ìƒì„±: $summary_file"
      
      - name: Commit and push results
        if: steps.organize.outputs.file_exists == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          csv_file="${{ steps.organize.outputs.csv_file }}"
          
          # ëª¨ë“  íŒŒì¼ ì¶”ê°€
          git add output/${year}/${month}/${day}/
          
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            # HACIE ìƒí’ˆ ìˆ˜ ê³„ì‚°
            hacie_count=$(grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | wc -l | xargs)
            
            kst_date=$(TZ=Asia/Seoul date '+%Yë…„ %mì›” %dì¼ %Hì‹œ')
            
            commit_msg="ðŸ“Š HACIE ì¼ì¼ ìˆœìœ„ ì¶”ì  (${year}.${month}.${day})

            - ë°œê²¬ ìƒí’ˆ: ${hacie_count}ê°œ
            - ë¶„ì„ ì‹œê°: ${kst_date}
            - íŒŒì¼: output/${year}/${month}/${day}/

            ìžë™ ìƒì„± by GitHub Actions"
            
            git commit -m "$commit_msg"
            git push
            
            echo "âœ“ ì»¤ë°‹ ì™„ë£Œ: ${hacie_count}ê°œ ìƒí’ˆ"
          fi
      
      - name: Create summary
        if: steps.organize.outputs.file_exists == 'true'
        run: |
          csv_file="${{ steps.organize.outputs.csv_file }}"
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          
          hacie_count=$(grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | wc -l | xargs)
          
          echo "# ðŸ† HACIE ì¼ì¼ ìˆœìœ„ ì¶”ì  ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë‚ ì§œ:** ${year}ë…„ ${month}ì›” ${day}ì¼" >> $GITHUB_STEP_SUMMARY
          echo "**ë¶„ì„ ì‹œê°:** $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S') KST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë°œê²¬ëœ HACIE ìƒí’ˆ:** ${hacie_count}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $hacie_count -gt 0 ]; then
            echo "## ðŸ“‹ ìƒìœ„ 10ê°œ ìƒí’ˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```csv' >> $GITHUB_STEP_SUMMARY
            head -1 "$csv_file" >> $GITHUB_STEP_SUMMARY
            grep -iE "HACIE|í•˜ì‹œì—" "$csv_file" 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload results as artifact
        if: steps.organize.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-rankings-${{ steps.organize.outputs.year }}-${{ steps.organize.outputs.month }}-${{ steps.organize.outputs.day }}
          path: output/${{ steps.organize.outputs.year }}/${{ steps.organize.outputs.month }}/${{ steps.organize.outputs.day }}/
          retention-days: 90
