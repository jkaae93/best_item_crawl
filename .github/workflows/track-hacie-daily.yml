name: Track HACIE Daily Rankings

on:
  schedule:
    # 매일 오전 8시 (KST = UTC+9, 즉 UTC 23시)
    - cron: '0 23 * * *'
  workflow_dispatch:  # 수동 실행 가능

permissions:
  contents: write

jobs:
  track-rankings:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/python:v1.55.0-jammy
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Cache pip packages
        uses: actions/cache@v4
        id: pip-cache
        with:
          path: /root/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          pip install --no-cache-dir -r requirements.txt
          python3 -c "import playwright; import requests; print('✅ 패키지 설치 확인 완료')"
      
      - name: Run HACIE rankings tracker
        id: track
        env:
          TZ: Asia/Seoul
          PYTHONUNBUFFERED: "1"
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}"
          
          # 출력 디렉토리 생성
          mkdir -p output
          
          # 스크립트 실행 (최대 3회 재시도)
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "🔄 시도 $attempt/$max_attempts..."
            
            if python3 scripts/wconcept_best_export.py; then
              echo "✅ 크롤링 성공!"
              exit 0
            else
              exit_code=$?
              echo "⚠️ 시도 $attempt 실패 (exit code: $exit_code)"
              
              if [ $attempt -lt $max_attempts ]; then
                wait_time=$((attempt * 30))
                echo "⏳ ${wait_time}초 대기 후 재시도..."
                sleep $wait_time
              fi
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "❌ 모든 시도 실패"
          exit 1
        continue-on-error: false
      
      - name: Organize files by date
        id: organize
        env:
          TZ: Asia/Seoul
        run: |
          # KST 기준 날짜
          year=$(date '+%Y')
          month=$(date '+%m')
          day=$(date '+%d')
          
          # yyyy/MM/dd 폴더 생성
          mkdir -p "output/${year}/${month}/${day}"
          
          # 최신 CSV 파일 이동
          if ls output/wconcept_best_*.csv 1> /dev/null 2>&1; then
            latest_csv=$(ls -t output/wconcept_best_*.csv | head -1)
            mv "$latest_csv" "output/${year}/${month}/${day}/"
            
            echo "year=${year}" >> $GITHUB_OUTPUT
            echo "month=${month}" >> $GITHUB_OUTPUT
            echo "day=${day}" >> $GITHUB_OUTPUT
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "csv_file=output/${year}/${month}/${day}/$(basename $latest_csv)" >> $GITHUB_OUTPUT
            
            echo "✓ CSV 파일 이동: output/${year}/${month}/${day}/$(basename $latest_csv)"
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ CSV 파일이 생성되지 않았습니다."
          fi
      
      - name: Generate daily summary
        if: steps.organize.outputs.file_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          csv_file="${{ steps.organize.outputs.csv_file }}"
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          
          # CSV 파일 존재 확인
          if [ ! -f "$csv_file" ]; then
            echo "❌ CSV 파일을 찾을 수 없습니다: $csv_file"
            exit 1
          fi
          
          # 일일 요약 생성
          summary_file="output/${year}/${month}/${day}/일일_요약.md"
          
          # HACIE 상품 개수 계산
          hacie_count=$(grep -iE "HACIE|하시에" "$csv_file" 2>/dev/null | wc -l | xargs)
          
          # 요약 파일 생성
          cat > "$summary_file" << EOF
          # 📊 ${year}년 ${month}월 ${day}일 일일 요약
          
          **분석 시각:** $(date '+%Y-%m-%d %H:%M KST')
          
          ## 주요 지표
          
          - **발견된 HACIE 상품:** ${hacie_count}개
          - **데이터 파일:** \`$(basename $csv_file)\`
          
          ## 📋 상위 5개 상품
          
          | 순위 | 카테고리 | 상품명 | 가격 |
          |:----:|---------|--------|-----:|
          EOF
          
          # TOP 5 상품 추출 (CSV: 날짜,시간,메인카테고리,서브카테고리,순위,상품명,가격)
          if grep -iE "HACIE|하시에" "$csv_file" 2>/dev/null | head -5 | while IFS=',' read -r date time depth1 depth2 rank name price rest; do
            # CSV에서 따옴표 제거
            name_clean=$(echo "$name" | sed 's/"//g')
            price_clean=$(echo "$price" | sed 's/"//g')
            echo "| ${rank} | ${depth2} | ${name_clean:0:40} | ${price_clean} |" >> "$summary_file"
          done; then
            :
          else
            echo "| - | - | 데이터 없음 | - |" >> "$summary_file"
          fi
          
          cat >> "$summary_file" << EOF
          
          ---
          
          *자동 생성 by GitHub Actions*
          EOF
          
          echo "✓ 일일 요약 생성: $summary_file"
      
      - name: Commit and push results
        if: steps.organize.outputs.file_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          # Git 안전 디렉토리 설정 (container 환경)
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          csv_file="${{ steps.organize.outputs.csv_file }}"
          
          # 원격 변경사항 가져오기 (충돌 방지)
          git fetch origin master
          git rebase origin/master || {
            echo "⚠️ rebase 충돌 발생, merge로 전환"
            git rebase --abort
            git merge origin/master -m "Merge remote changes" || {
              echo "❌ merge 실패, 변경사항 확인 필요"
              exit 1
            }
          }
          
          # 모든 파일 추가
          git add output/${year}/${month}/${day}/
          
          if git diff --staged --quiet; then
            echo "변경사항이 없습니다."
          else
            # HACIE 상품 수 계산
            hacie_count=$(grep -iE "HACIE|하시에" "$csv_file" 2>/dev/null | wc -l | xargs)
            
            kst_date=$(date '+%Y년 %m월 %d일 %H시')
            
            commit_msg="📊 HACIE 일일 순위 추적 (${year}.${month}.${day})

            - 발견 상품: ${hacie_count}개
            - 분석 시각: ${kst_date}
            - 파일: output/${year}/${month}/${day}/

            자동 생성 by GitHub Actions"
            
            git commit -m "$commit_msg"
            
            # Push 재시도 로직
            max_push_attempts=3
            push_attempt=1
            
            while [ $push_attempt -le $max_push_attempts ]; do
              echo "🔄 Push 시도 $push_attempt/$max_push_attempts..."
              
              if git push origin master; then
                echo "✓ 커밋 완료: ${hacie_count}개 상품"
                exit 0
              else
                echo "⚠️ Push 실패, 원격 변경사항 다시 가져오기..."
                git fetch origin master
                git rebase origin/master || {
                  git rebase --abort
                  git merge origin/master -m "Merge remote changes during push retry"
                }
                
                push_attempt=$((push_attempt + 1))
                
                if [ $push_attempt -le $max_push_attempts ]; then
                  sleep 5
                fi
              fi
            done
            
            echo "❌ Push 최종 실패"
            exit 1
          fi
      
      - name: Create summary
        if: steps.organize.outputs.file_exists == 'true'
        env:
          TZ: Asia/Seoul
        run: |
          csv_file="${{ steps.organize.outputs.csv_file }}"
          year="${{ steps.organize.outputs.year }}"
          month="${{ steps.organize.outputs.month }}"
          day="${{ steps.organize.outputs.day }}"
          
          hacie_count=$(grep -iE "HACIE|하시에" "$csv_file" 2>/dev/null | wc -l | xargs)
          
          echo "# 🏆 HACIE 일일 순위 추적 결과" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**날짜:** ${year}년 ${month}월 ${day}일" >> $GITHUB_STEP_SUMMARY
          echo "**분석 시각:** $(date '+%Y-%m-%d %H:%M:%S') KST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**발견된 HACIE 상품:** ${hacie_count}개" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $hacie_count -gt 0 ]; then
            echo "## 📋 상위 10개 상품" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```csv' >> $GITHUB_STEP_SUMMARY
            head -1 "$csv_file" >> $GITHUB_STEP_SUMMARY
            grep -iE "HACIE|하시에" "$csv_file" 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload results as artifact
        if: steps.organize.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-rankings-${{ steps.organize.outputs.year }}-${{ steps.organize.outputs.month }}-${{ steps.organize.outputs.day }}
          path: output/${{ steps.organize.outputs.year }}/${{ steps.organize.outputs.month }}/${{ steps.organize.outputs.day }}/
          retention-days: 90
